name: ðŸ”‘ Secret Detection & Rotation
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run secret detection every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_rotation:
        description: 'Force secret rotation'
        required: false
        default: 'false'
        type: boolean
permissions:
  contents: read
  security-events: write
  actions: write
  issues: write
jobs:
  trufflehog-scan:
    name: ðŸ· TruffleHog Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true  # Non-blocking while we triage external scanner issues
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ” Run TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified --json --github-actions
  gitleaks-scan:
    name: ðŸ” GitLeaks Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ” Run GitLeaks Scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
  secretlint-scan:
    name: ðŸ” Secretlint Pattern Detection
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Non-blocking while we triage external scanner issues
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ðŸ“¦ Install Secretlint
      run: |
        npm install -g @secretlint/cli @secretlint/secretlint-rule-preset-recommend
    
    - name: ðŸ” Run Secretlint Scan
      run: |
        secretlint "**/*" --format json --output secretlint-report.json || true
        secretlint "**/*"
    
    - name: ðŸ“Š Upload Secretlint Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: secretlint-report
        path: secretlint-report.json
        retention-days: 30
  detect-secrets-scan:
    name: ðŸ•µï¸ IBM Detect Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: ðŸ“¦ Install detect-secrets
      run: |
        pip install detect-secrets
    
    - name: ðŸ” Run detect-secrets scan
      run: |
        detect-secrets scan --all-files --baseline .secrets.baseline || true
        detect-secrets audit .secrets.baseline || true
    
    - name: ðŸ“Š Upload detect-secrets baseline
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: secrets-baseline
        path: .secrets.baseline
        retention-days: 30
  azure-key-vault-rotation:
    name: ðŸ”„ Azure Key Vault Secret Rotation
    runs-on: ubuntu-latest
    if: github.event.inputs.force_rotation == 'true' || github.event_name == 'schedule'
    timeout-minutes: 20
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸ”„ Rotate API Keys
      uses: azure/powershell@v1
      with:
        azPSVersion: 'latest'
        inlineScript: |
          # Azure Key Vault secret rotation script
          $keyVaultName = "${{ secrets.AZURE_KEY_VAULT_NAME }}"
          $secrets = @('api-key-1', 'database-password', 'service-principal-secret')
          
          foreach ($secretName in $secrets) {
            try {
              Write-Host "ðŸ”„ Rotating secret: $secretName"
              
              # Get current secret
              $currentSecret = Get-AzKeyVaultSecret -VaultName $keyVaultName -Name $secretName
              
              # Generate new secret (example for API key)
              if ($secretName -like "*api-key*") {
                $newSecret = [System.Web.Security.Membership]::GeneratePassword(32, 5)
              } else {
                $newSecret = [System.Web.Security.Membership]::GeneratePassword(24, 3)
              }
              
              # Update secret in Key Vault
              Set-AzKeyVaultSecret -VaultName $keyVaultName -Name $secretName -SecretValue (ConvertTo-SecureString $newSecret -AsPlainText -Force)
              
              Write-Host "âœ… Successfully rotated: $secretName"
            }
            catch {
              Write-Error "âŒ Failed to rotate secret: $secretName - $($_.Exception.Message)"
            }
          }
  github-secrets-audit:
    name: ðŸ” GitHub Secrets Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ” Audit GitHub Secrets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Auditing GitHub repository secrets..."
        
        # List of required secrets for security framework
        required_secrets=(
          "AZURE_CREDENTIALS"
          "AZURE_KEY_VAULT_NAME"
          "SEMGREP_APP_TOKEN"
          "GITLEAKS_LICENSE"
          "SNYK_TOKEN"
          "DEFENDER_API_KEY"
          "SENTINEL_WORKSPACE_ID"
        )
        
        echo "ðŸ“‹ Required secrets checklist:" > secrets-audit.md
        for secret in "${required_secrets[@]}"; do
          echo "- [ ] $secret" >> secrets-audit.md
        done
        
        echo "âš ï¸ Please ensure all required secrets are configured in repository settings"
    
    - name: ðŸ“Š Upload Secrets Audit
      uses: actions/upload-artifact@v4
      with:
        name: secrets-audit-report
        path: secrets-audit.md
        retention-days: 30
  secret-rotation-notification:
    name: ðŸ“¢ Secret Rotation Notifications
    runs-on: ubuntu-latest
    needs: [azure-key-vault-rotation]
    if: always() && needs.azure-key-vault-rotation.result != 'skipped'
    
    steps:
    - name: ðŸ“§ Teams Notification
      if: needs.azure-key-vault-rotation.result == 'success'
      run: |
        curl -H "Content-Type: application/json" -d '{
          "@type": "MessageCard",
          "@context": "https://schema.org/extensions",
          "summary": "Secret Rotation Completed",
          "themeColor": "00FF00",
          "sections": [{
            "activityTitle": "ðŸ”„ Secret Rotation Completed",
            "activitySubtitle": "Repository: ${{ github.repository }}",
            "facts": [{
              "name": "Status:",
              "value": "âœ… Success"
            }, {
              "name": "Timestamp:",
              "value": "'$(date)'"
            }]
          }]
        }' ${{ secrets.TEAMS_WEBHOOK_URL }} || echo "Teams webhook not configured"
    
    - name: ðŸš¨ Alert on Failure
      if: needs.azure-key-vault-rotation.result == 'failure'
      run: |
        curl -H "Content-Type: application/json" -d '{
          "@type": "MessageCard",
          "@context": "https://schema.org/extensions",
          "summary": "Secret Rotation Failed",
          "themeColor": "FF0000",
          "sections": [{
            "activityTitle": "âŒ Secret Rotation Failed",
            "activitySubtitle": "Repository: ${{ github.repository }}",
            "facts": [{
              "name": "Status:",
              "value": "âŒ Failed"
            }, {
              "name": "Action Required:",
              "value": "Manual intervention needed"
            }]
          }]
        }' ${{ secrets.TEAMS_WEBHOOK_URL }} || echo "Teams webhook not configured"
  security-summary:
    name: ðŸ“Š Secret Detection Summary
    runs-on: ubuntu-latest
    needs: [trufflehog-scan, gitleaks-scan, secretlint-scan, detect-secrets-scan, github-secrets-audit]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Secret Detection Summary
      run: |
        echo "# ðŸ”‘ Secret Detection & Rotation Summary" > secret-summary.md
        echo "**Scan Date:** $(date)" >> secret-summary.md
        echo "**Repository:** ${{ github.repository }}" >> secret-summary.md
        echo "" >> secret-summary.md
        
        echo "## ðŸ” Detection Results" >> secret-summary.md
        echo "- âœ… TruffleHog Scan: ${{ needs.trufflehog-scan.result }}" >> secret-summary.md
        echo "- âœ… GitLeaks Scan: ${{ needs.gitleaks-scan.result }}" >> secret-summary.md
        echo "- âœ… Secretlint Scan: ${{ needs.secretlint-scan.result }}" >> secret-summary.md
        echo "- âœ… IBM Detect-Secrets: ${{ needs.detect-secrets-scan.result }}" >> secret-summary.md
        echo "- âœ… GitHub Secrets Audit: ${{ needs.github-secrets-audit.result }}" >> secret-summary.md
        echo "" >> secret-summary.md
        
        if [[ "${{ github.event.inputs.force_rotation }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
          echo "## ðŸ”„ Rotation Status" >> secret-summary.md
          echo "- Secret rotation was triggered" >> secret-summary.md
        fi
        
        echo "ðŸ“Š **View detailed results in Security tab**" >> secret-summary.md
    
    - name: ðŸ“¤ Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: secret-detection-summary
        path: secret-summary.md
        retention-days: 30
